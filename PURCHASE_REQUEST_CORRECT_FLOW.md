# Purchase Request - CORRECT Flow (Updated)

## üè¢ Chain of Command

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    ORGANIZATIONAL HIERARCHY                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. OWNER (Top Level)
   - Final authority
   - Approves high-value purchase requests (> Br 50,000)

2. ADMIN (Next to Owner)
   - Can approve purchase requests up to threshold (‚â§ Br 50,000)
   - Has approval authority for routine purchases

3. FINANCE
   - Tracks all financial transactions
   - Processes payments after approval
   - Manages company funds

4. SALES
   - Requests purchases for their needs
   - Can pay from daily sales revenue if available
   - Otherwise, Finance pays with Admin/Owner approval

5. MANAGER
   - **Factory operations ONLY**
   - **NOT in purchase approval chain!**
   - Handles production, inventory, gate passes
```

## üîÑ Purchase Request Workflow (CORRECTED)

### Flow Diagram:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              PURCHASE REQUEST APPROVAL FLOW                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Step 1: SALES CREATES REQUEST
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  üìù Sales person identifies need and creates purchase request
  ‚Üì
  System automatically routes based on amount:
  
  
  IF Amount ‚â§ Br 50,000 (Admin Threshold)
  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
    ‚Üì
    Status: "pending_admin_approval"
    Routing: ‚Üí ADMIN
    
    ‚Üì
    Step 2: ADMIN APPROVES
    ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      ‚úÖ Admin reviews and approves
      ‚Üì
      Status: "admin_approved"
      ‚Üì
      Step 3: FINANCE PROCESSES PAYMENT
      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
        üí∞ Finance pays from company funds
        OR
        üí∞ Sales pays from daily revenue (if available)
        ‚Üì
        Status: "completed"


  IF Amount > Br 50,000 (Exceeds Admin Threshold)
  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
    ‚Üì
    Status: "pending_owner_approval"
    Routing: ‚Üí OWNER
    
    ‚Üì
    Step 2: OWNER APPROVES
    ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      ‚úÖ Owner reviews and approves
      ‚Üì
      Status: "owner_approved"
      ‚Üì
      Step 3: FINANCE PROCESSES PAYMENT
      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
        üí∞ Finance pays from company funds
        OR
        üí∞ Sales pays from daily revenue (if available)
        ‚Üì
        Status: "completed"


  ‚ùå REJECTION (Can happen at any stage)
  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
    Admin or Owner can reject
    ‚Üì
    Status: "rejected"
    ‚Üì
    Process ends
```

## üìä Status Definitions

| Status | Meaning | Who Can See It | Next Action |
|--------|---------|----------------|-------------|
| `pending_admin_approval` | Amount ‚â§ Br 50,000, waiting for admin | **Admin Dashboard** | Admin approves/rejects |
| `pending_owner_approval` | Amount > Br 50,000, waiting for owner | **Owner Dashboard ‚Üí Approvals** | Owner approves/rejects |
| `admin_approved` | Admin approved, ready for payment | **Finance Dashboard** | Finance processes payment |
| `owner_approved` | Owner approved, ready for payment | **Finance Dashboard** | Finance processes payment |
| `completed` | Payment processed and completed | All (history) | Archived |
| `rejected` | Rejected by Admin or Owner | All (history) | No further action |

## üéØ Role Responsibilities

### OWNER
- ‚úÖ Approves purchase requests > Br 50,000
- ‚úÖ Can reject any purchase request
- ‚úÖ Final authority on all purchases
- ‚ùå Does NOT see small purchases (‚â§ Br 50,000)

### ADMIN
- ‚úÖ Approves purchase requests ‚â§ Br 50,000
- ‚úÖ Can reject any purchase request
- ‚úÖ Manages routine operational purchases
- ‚ùå Cannot approve purchases > Br 50,000

### FINANCE
- ‚úÖ Tracks ALL purchase requests
- ‚úÖ Processes payments for approved requests
- ‚úÖ Can pay from company funds or coordinate with Sales
- ‚úÖ Records all financial transactions
- ‚ùå Cannot approve (only pays)

### SALES
- ‚úÖ Creates purchase requests for their needs
- ‚úÖ Can pay from daily sales revenue if available
- ‚úÖ Tracks their own purchase requests
- ‚ùå Cannot approve their own requests

### MANAGER (Factory Operations)
- ‚úÖ Handles wheat delivery
- ‚úÖ Manages milling orders
- ‚úÖ Approves gate passes for finished products
- ‚úÖ Approves stock transfers
- ‚ùå **NOT in purchase request approval chain!**
- ‚ùå Does not see or approve purchase requisitions

## üí∞ Admin Approval Threshold

The admin threshold can be configured in Financial Controls:

**Default: Br 50,000**

- Purchases ‚â§ Br 50,000 ‚Üí Admin can approve
- Purchases > Br 50,000 ‚Üí Requires Owner approval

This threshold can be adjusted by Owner in:
`Owner Dashboard ‚Üí Financial Controls ‚Üí Admin Purchase Approval Threshold`

## üñ•Ô∏è Where to Find Purchase Requests

### Admin Dashboard
```
Status to filter: pending_admin_approval

Endpoint: GET /api/purchase-requisitions?status=pending_admin_approval

UI Location: Admin Dashboard ‚Üí Purchase Approvals (to be added)
```

### Owner Dashboard
```
Status to filter: pending_owner_approval

Endpoint: GET /api/purchase-requisitions?status=pending_owner_approval

UI Location: Owner Dashboard ‚Üí Approvals ‚Üí Other Approvals tab
```

### Finance Dashboard
```
Status to filter: admin_approved OR owner_approved

Endpoint: GET /api/purchase-requisitions?status=admin_approved
          GET /api/purchase-requisitions?status=owner_approved

UI Location: Finance Dashboard ‚Üí Pending Authorizations
```

### Sales Dashboard
```
View their own requests: GET /api/purchase-requisitions

UI Location: Sales Dashboard ‚Üí Purchase Request tab
             (Shows all their requests with current status)
```

## üîå API Endpoints

### Create Purchase Request
```bash
POST /api/purchase-requests

Body:
{
  "description": "Office Supplies",
  "item_name": "Pens and Paper",
  "quantity": 100,
  "unit": "items",
  "estimated_cost": 35000,
  "supplier_name": "Office Mart",
  "requested_by": "Sales Person Name",
  "branch_id": "sales_branch",
  "urgency": "normal",
  "category": "supplies",
  "payment_source": "finance"  // or "sales_revenue"
}

Response:
{
  "id": "uuid",
  "request_number": "PR-20251012-xxxx",
  "status": "pending_admin_approval",  // or "pending_owner_approval"
  "routing": "admin",  // or "owner"
  "admin_threshold": 50000,
  ...
}
```

### Admin Approval
```bash
PUT /api/purchase-requisitions/{id}/approve-admin

Body:
{
  "approved_by": "Admin Name",
  "notes": "Approved for operational needs"
}

Response:
{
  "status": "admin_approved",
  "next_step": "finance_payment",
  ...
}
```

### Owner Approval
```bash
PUT /api/purchase-requisitions/{id}/approve-owner

Body:
{
  "approved_by": "Owner Name",
  "notes": "Approved"
}

Response:
{
  "status": "owner_approved",
  "next_step": "finance_payment",
  ...
}
```

### Rejection
```bash
PUT /api/purchase-requisitions/{id}/reject

Body:
{
  "rejected_by": "Admin Name",  // or "Owner Name"
  "rejection_reason": "Not in budget"
}

Response:
{
  "status": "rejected",
  ...
}
```

### Query Purchase Requests
```bash
# All requests
GET /api/purchase-requisitions

# Filter by status
GET /api/purchase-requisitions?status=pending_admin_approval
GET /api/purchase-requisitions?status=pending_owner_approval
GET /api/purchase-requisitions?status=admin_approved
GET /api/purchase-requisitions?status=owner_approved

# Filter by branch
GET /api/purchase-requisitions?branch_id=sales_branch
```

## üß™ Testing Examples

### Example 1: Small Purchase (Admin Approves)
```bash
# 1. Sales creates request (Br 25,000 - under threshold)
curl -X POST http://localhost:8000/api/purchase-requests \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Office Supplies",
    "item_name": "Stationery",
    "estimated_cost": 25000,
    "requested_by": "Sales Person"
  }'

# Response shows: "status": "pending_admin_approval"

# 2. Admin approves
curl -X PUT http://localhost:8000/api/purchase-requisitions/{id}/approve-admin \
  -H "Content-Type: application/json" \
  -d '{
    "approved_by": "Admin",
    "notes": "Approved"
  }'

# Response shows: "status": "admin_approved", "next_step": "finance_payment"

# 3. Finance processes payment (to be implemented)
```

### Example 2: Large Purchase (Owner Approves)
```bash
# 1. Sales creates request (Br 75,000 - above threshold)
curl -X POST http://localhost:8000/api/purchase-requests \
  -H "Content-Type: application/json" \
  -d '{
    "description": "New Equipment",
    "item_name": "Packaging Machine",
    "estimated_cost": 75000,
    "requested_by": "Sales Person"
  }'

# Response shows: "status": "pending_owner_approval"

# 2. Owner approves
curl -X PUT http://localhost:8000/api/purchase-requisitions/{id}/approve-owner \
  -H "Content-Type: application/json" \
  -d '{
    "approved_by": "Owner",
    "notes": "Approved for expansion"
  }'

# Response shows: "status": "owner_approved", "next_step": "finance_payment"

# 3. Finance processes payment (to be implemented)
```

## ‚úÖ What Changed from Previous Flow

### REMOVED:
- ‚ùå Manager approval step
- ‚ùå Three-level approval (Manager ‚Üí Admin ‚Üí Owner)
- ‚ùå Manager visibility of purchase requests

### ADDED:
- ‚úÖ Automatic routing based on amount
- ‚úÖ Admin threshold check
- ‚úÖ Direct routing to Admin OR Owner (not both)
- ‚úÖ Payment source tracking (Finance vs Sales Revenue)

### KEPT:
- ‚úÖ Owner final authority
- ‚úÖ Finance payment processing
- ‚úÖ Rejection capability
- ‚úÖ Status tracking

## üöÄ Next Steps

### For Immediate Use:
1. **Check your pending requests:**
   ```bash
   curl "http://localhost:8000/api/purchase-requisitions?status=pending_admin_approval"
   curl "http://localhost:8000/api/purchase-requisitions?status=pending_owner_approval"
   ```

2. **Update existing pending requests** (if needed):
   - Requests with "pending" status should be updated to either:
     - "pending_admin_approval" (if amount ‚â§ Br 50,000)
     - "pending_owner_approval" (if amount > Br 50,000)

3. **Add Admin Approval Screen:**
   - Create Admin Dashboard ‚Üí Purchase Approvals tab
   - Show requests with status "pending_admin_approval"
   - Allow approve/reject actions

4. **Update Finance Dashboard:**
   - Show requests with status "admin_approved" OR "owner_approved"
   - Add payment processing functionality

---

*This is the CORRECT flow based on your organizational structure!*
*Manager is NOT in the purchase approval chain - they only handle factory operations.*


