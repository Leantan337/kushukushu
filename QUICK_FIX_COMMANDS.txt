â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              QUICK FIX COMMANDS - Purchase Request Flow                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ WHAT TO DO NOW:

Step 1: Fix Existing Requests in MongoDB
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Option A: Using MongoDB Shell
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

mongosh
use kushukushu_erp

db.purchase_requisitions.updateMany(
  { status: "pending" },
  [{
    $set: {
      status: {
        $cond: {
          if: { $lte: ["$estimated_cost", 50000] },
          then: "pending_admin_approval",
          else: "pending_owner_approval"
        }
      },
      routing: {
        $cond: {
          if: { $lte: ["$estimated_cost", 50000] },
          then: "admin",
          else: "owner"
        }
      },
      admin_threshold: 50000
    }
  }]
)


Option B: Using MongoDB Compass
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Open MongoDB Compass
2. Connect to: mongodb://localhost:27017
3. Select database: kushukushu_erp
4. Select collection: purchase_requisitions
5. Click "Aggregations" tab
6. Paste the aggregation from fix_requests.mongodb.js
7. Click "Run"


Option C: Using Python Script
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Create fix_db.py:

from motor.motor_asyncio import AsyncIOMotorClient
import asyncio

async def fix():
    client = AsyncIOMotorClient('mongodb://localhost:27017')
    db = client['kushukushu_erp']
    
    result = await db.purchase_requisitions.update_many(
        {"status": "pending"},
        {
            "$set": {
                "status": "pending_admin_approval",
                "routing": "admin",
                "admin_threshold": 50000
            }
        }
    )
    
    print(f"âœ… Fixed {result.modified_count} requests")
    
asyncio.run(fix())

Then run: python fix_db.py


Step 2: Verify the Fix
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Check admin requests
curl "http://localhost:8000/api/purchase-requisitions?status=pending_admin_approval"

# Should show 7 requests!


Step 3: Test Admin Approval
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Approve one request (replace {id} with actual request ID)
curl -X PUT http://localhost:8000/api/purchase-requisitions/{id}/approve-admin \
  -H "Content-Type: application/json" \
  -d '{"approved_by": "Admin", "notes": "Approved"}'


Step 4: Check Finance Queue
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# See approved requests waiting for payment
curl "http://localhost:8000/api/purchase-requisitions?status=admin_approved"


Step 5: Test with New High-Value Request
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Create request over Br 50,000 (should go to Owner)
curl -X POST http://localhost:8000/api/purchase-requests \
  -H "Content-Type: application/json" \
  -d '{
    "description": "New Equipment",
    "item_name": "Packaging Machine",
    "estimated_cost": 75000,
    "quantity": 1,
    "unit": "unit",
    "supplier_name": "Equipment Co",
    "requested_by": "Sales Person",
    "branch_id": "sales_branch"
  }'

# Check it went to Owner
curl "http://localhost:8000/api/purchase-requisitions?status=pending_owner_approval"


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š CURRENT SITUATION:

Your 7 pending purchase requests:
â€¢ PR-20251012131929-9340 - Fuel (Br 3,500)
â€¢ PR-20251012131929-110d - Office Supplies (Br 2,500)
â€¢ PR-20251012125352-bf9c - Office Supplies (Br 2,500)
â€¢ PR-20251012120808-035f - (Br 1)
â€¢ PR-20251011212938-be8b - (Br 99.99)
â€¢ ...and 2 more

ALL are under Br 50,000
â†’ ALL should go to ADMIN
â†’ Just run the MongoDB fix command above!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”§ WHAT WAS CHANGED IN THE CODE:

âœ… backend/server.py:
   â€¢ create_purchase_request() - Auto-routes based on amount
   â€¢ approve_admin() - Checks threshold, approves â‰¤ Br 50,000
   â€¢ approve_owner() - Approves > Br 50,000
   â€¢ REMOVED approve_manager() - Manager out of chain!

âœ… frontend/src/components/owner/ApprovalsScreen.jsx:
   â€¢ Changed to fetch: status=pending_owner_approval

âœ… Frontend rebuilt successfully!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“š DOCUMENTATION:

â€¢ PURCHASE_REQUEST_CORRECT_FLOW.md - Full documentation
â€¢ CORRECTED_FLOW_SUMMARY.txt       - Visual summary
â€¢ fix_requests.mongodb.js          - MongoDB fix script
â€¢ QUICK_FIX_COMMANDS.txt           - This file

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

